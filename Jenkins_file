pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        disableConcurrentBuilds()
    }

    triggers { pollSCM('H/10 * * * *') }

    environment {
        FIREBASE_PROJECT = 'jenkins-proj-ade17'
        PUBLIC_DIR       = 'dist'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm install'   // works even without package-lock.json
            }
        }

        stage('Build') {
            steps {
                bat 'npm run build'
            }
        }

        stage('Deploy to Firebase Hosting') {
            steps {
                withCredentials([string(credentialsId: 'firebase-service-account-json', variable: 'TOKEN')]) {
                    bat """
                        npm install -g firebase-tools
                        firebase deploy --only hosting --project jenkins-proj-ade17 --token "%TOKEN%" --message "Jenkins build #${BUILD_NUMBER}"
                    """
                }
            }
        }
    }

    post {
        success { echo 'Deployed successfully! Check https://automation-hosting.web.app' }
        failure { echo 'Deployment failed' }
        always  { cleanWs() }
    }
}
